import pandas as pd
import os
from datetime import datetime

# обрабатывает excel файл и сохраняет результат
def обработать_файл(путь_к_файлу, имя_колонки='сумма'):
    print(f"Читаю файл: {путь_к_файлу}")
    
    try:
        данные = pd.read_excel(путь_к_файлу)
        print(f"Файл прочитан, строк: {len(данные)}")
    except FileNotFoundError:
        print(f"Файл не найден: {путь_к_файлу}")
        return
    except Exception as e:
        print(f"Ошибка: {e}")
        return
    
    print("\nПервые строки:")
    print(данные.head())
    
    # считаем статистику
    print(f"\nСтатистика по '{имя_колонки}':")
    
    if имя_колонки in данные.columns:
        сумма = данные[имя_колонки].sum()
        среднее = данные[имя_колонки].mean()
        максимум = данные[имя_колонки].max()
        минимум = данные[имя_колонки].min()
        
        print(f"Сумма: {сумма:,.2f}")
        print(f"Среднее: {среднее:,.2f}")
        print(f"Максимум: {максимум:,.2f}")
        print(f"Минимум: {минимум:,.2f}")
    else:
        print(f"Колонка '{имя_колонки}' не найдена")
        print(f"Есть колонки: {', '.join(данные.columns)}")
    
    # создаем папку если нет
    if not os.path.exists("результаты"):
        os.makedirs("результаты")
    
    # сохраняем
    имя_файла = os.path.basename(путь_к_файлу)
    имя_без_расширения = os.path.splitext(имя_файла)[0]
    время = datetime.now().strftime("%Y%m%d_%H%M%S")
    путь_результата = f"результаты/{имя_без_расширения}_обработано_{время}.xlsx"
    
    данные.to_excel(путь_результата, index=False)
    print(f"\nСохранено: {путь_результата}")
    
    return путь_результата


def создать_пример_файла():
    print("Создаю пример файла...")
    
    пример_данных = {
        'название': ['Товар А', 'Товар Б', 'Товар В', 'Товар Г', 'Товар Д'],
        'количество': [10, 25, 15, 30, 20],
        'сумма': [1000, 2500, 1500, 3000, 2000],
        'дата': ['2025-01-15', '2025-01-16', '2025-01-17', '2025-01-18', '2025-01-19']
    }
    
    df = pd.DataFrame(пример_данных)
    df.to_excel("пример_данных.xlsx", index=False)
    print("Готово: пример_данных.xlsx")
    
    return "пример_данных.xlsx"


if __name__ == "__main__":
    print("Скрипт обработки Excel файлов")
    print("=" * 40)
    
    # создаем пример если нет
    пример_файла = "пример_данных.xlsx"
    if not os.path.exists(пример_файла):
        пример_файла = создать_пример_файла()
    
    print()
    обработать_файл(пример_файла, имя_колонки='сумма')
    
    print("\nГотово!")
